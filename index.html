<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Great Lakes Weather (PWA)</title>
<meta name="theme-color" content="#2f80ed">

<style>
/* ====== Your original look & feel (kept) ====== */
body {font-family:Arial,sans-serif;margin:20px;}
label,select,button{font-size:1.05rem;margin:6px;}
#tip {font-size:0.9rem;color:#444;margin-top:4px;margin-bottom:14px;}
#weather{margin-top:20px;border-top:1px solid #ccc;padding-top:10px;}
.wind-row{display:flex;flex-wrap:wrap;gap:10px;}
.wind-item{background:#f6f6f6;padding:6px 10px;border-radius:6px;}
.error{color:#a00;}
footer{margin-top:24px;font-size:0.9rem;color:#555;border-top:1px solid #ddd;padding-top:12px;}
#version{font-size:0.85rem;color:#777;margin-top:8px;}
.modal{display:none;position:fixed;z-index:10;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);}
.modal-content{background:#fff;margin:10% auto;padding:20px;border-radius:10px;width:90%;max-width:500px;text-align:center;}
.close{float:right;font-size:1.4rem;cursor:pointer;}
code {background:#f4f4f4;padding:2px 6px;border-radius:4px;}

/* ====== Tiny install toast (new) ====== */
#installToast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; z-index:9999; background:#2f80ed; color:#fff;
  padding:10px 14px; border-radius:999px; font-size:0.95rem;
  box-shadow:0 6px 18px rgba(0,0,0,.2); display:none;
}
</style>
</head>
<body>
<h1>Great Lakes Boating Weather Tool</h1>

<label for="lake">Choose a location:</label>
<select id="lake">
  <!-- Lake Ontario -->
  <option value="43.9,-77.7">Lake Ontario near Presqu'ile Point (43.9,-77.7)</option>
  <option value="44.1,-76.6">Lake Ontario near Wolfe Island (44.1,-76.6)</option>
  <option value="44.94,-78.17">Lake Ontario near Cobourg (44.94,-78.17)</option>
  <option value="43.58,-79.36">Lake Ontario near Toronto (43.58,-79.36)</option>
  <option value="43.29,-79.75">Lake Ontario near Hamilton (43.29,-79.75)</option>
  <option value="43.25,-79.21">Lake Ontario near Welland Canal Entrance (43.25,-79.21)</option>
  <option value="43.29,-79.08">Lake Ontario near Niagara-on-the-Lake (43.29,-79.08)</option>
  <option value="43.33,-78.84">Lake Ontario near Wilson NY, USA (43.33,-78.84)</option>
  <option value="43.34,-78.72">Lake Ontario near Olcott NY, USA (43.34,-78.72)</option>
  <option value="43.27,-77.54">Lake Ontario near Rochester NY, USA (43.27,-77.54)</option>

  <!-- Lake Erie -->
  <option value="42.86,-78.92">Lake Erie near Buffalo (42.86,-78.92)</option>
  <option value="42.78,-80.2">Lake Erie near Port Dover (42.78,-80.2)</option>
  <option value="42.86,-79.25">Lake Erie near Port Colborne (42.86,-79.25)</option>
  <option value="42.68,-80.32">Lake Erie near Turkey Point (42.68,-80.32)</option>
  <option value="42.55,-80.39">Lake Erie near Long Point (42.55,-80.39)</option>
  <option value="41.77,-82.65">Lake Erie on Pelee Island (41.77,-82.65)</option>
  <option value="42.0,-83.1">Lake Erie near Windsor (42.0,-83.1)</option>

  <!-- Lake Huron -->
  <option value="43.75,-81.7">Lake Huron near Goderich (43.75,-81.7)</option>
  <option value="45.27,-81.67">Lake Huron near Tobermory (45.27,-81.67)</option>
  <option value="44.63,-81.39">Lake Huron near Sauble Beach (44.63,-81.39)</option>
  <option value="43.03,-82.4">Lake Huron near Sarnia (43.03,-82.4)</option>
  <option value="45.8,-84.7">Lake Huron near St Ignace (45.8,-84.7)</option>

  <!-- Georgian Bay -->
  <option value="45.5,-80.7">Georgian Bay near Pointe au Baril (45.5,-80.7)</option>
  <option value="44.54,-80.05">Georgian Bay near Wasaga Beach (44.54,-80.05)</option>

  <!-- Lake Michigan -->
  <option value="44.65,-87.90">Lake Michigan near Green Bay (44.65,-87.90)</option>
  <option value="41.9,-87.3">Lake Michigan near Chicago (41.9,-87.3)</option>

  <!-- Lake Superior -->
  <option value="46.5,-84.3">Lake Superior near Sault Ste. Marie (46.5,-84.3)</option>
  <option value="47.9,-85.0">Lake Superior near Wawa (47.9,-85.0)</option>
  <option value="48.1,-88.9">Lake Superior near Thunder Bay (48.1,-88.9)</option>
  <option value="46.8,-92.0">Lake Superior near Duluth (46.8,-92.0)</option>
</select>
<p id="tip">üí° Tip: You can add your own locations using decimal GPS coordinates (latitude,longitude) ‚Äî e.g., <code>43.25,-79.87</code></p>

<button id="btnGet">Refresh Weather</button>
<button id="btnReadMe">ReadMe / Enter Key</button>
<button id="btnNewLoc">New Location</button>

<div id="weather"></div>

<footer>
  ¬© 2025 <strong>Boater-Aid / Glen Carruthers</strong> ‚Äî All rights reserved.<br>
  <div id="version">Version: v5.5-PWA ‚Äî Built: November 2025</div>
  <a href="#" id="aboutLink">About / Legal</a>
</footer>

<div id="aboutModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <p><strong>Boater-Aid Great Lakes Weather Tool</strong></p>
    <p>¬© 2025 Glen Carruthers / Boater-Aid.<br>Protected by Canadian and international copyright law.</p>
  </div>
</div>

<div id="installToast">‚úÖ App installed and ready for offline use</div>

<script>
/* ==========================
   PWA: manifest + icons + service worker (all embedded)
   ========================== */

/* Generate GLW icon (blue text, white cloud on gray bg) */
function generateGLWIcon(size){
  const c=document.createElement('canvas'); c.width=c.height=size;
  const ctx=c.getContext('2d');

  // Gray background
  ctx.fillStyle='#cccccc'; ctx.fillRect(0,0,size,size);

  // White cloud
  ctx.fillStyle='#ffffff';
  const cx=size*0.5, cy=size*0.60, r=size*0.18;
  ctx.beginPath();
  ctx.arc(cx-r*1.1, cy, r*0.9, 0, Math.PI*2);
  ctx.arc(cx, cy-r*0.45, r*1.1, 0, Math.PI*2);
  ctx.arc(cx+r*1.1, cy, r, 0, Math.PI*2);
  ctx.closePath(); ctx.fill();
  ctx.fillRect(cx-r*2, cy, r*4, r*0.9);

  // "GLW" text in Boater-Aid blue
  ctx.fillStyle='#2f80ed';
  ctx.font=`${Math.round(size*0.28)}px Arial Black, Arial, sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('GLW', size/2, size*0.28);

  return c.toDataURL('image/png');
}

const icon192=generateGLWIcon(192);
const icon512=generateGLWIcon(512);

/* Attach manifest via Blob URL so this stays single-file */
const manifest = {
  name: "Great Lakes Weather (PWA)",
  short_name: "GLW",
  start_url: "./",
  scope: "./",
  display: "standalone",
  theme_color: "#2f80ed",
  background_color: "#cccccc",
  icons: [
    { src: icon192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
    { src: icon512, sizes: "512x512", type: "image/png", purpose: "any maskable" }
  ]
};
const manifestBlob=new Blob([JSON.stringify(manifest)],{type:"application/manifest+json"});
const manifestURL=URL.createObjectURL(manifestBlob);
const link=document.createElement('link'); link.rel='manifest'; link.href=manifestURL;
document.head.appendChild(link);

/* Lightweight service worker (dynamic cache for same-origin only) */
const swCode = `
  const CACHE_NAME='glw-pwa-v5-5';
  self.addEventListener('install',e=>{ self.skipWaiting(); });
  self.addEventListener('activate',e=>{
    e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE_NAME?caches.delete(k):null))));
    self.clients.claim();
  });
  self.addEventListener('fetch',e=>{
    const req=e.request;
    if(req.method!=='GET') return;
    const sameOrigin = new URL(req.url).origin === location.origin;

    if(sameOrigin){
      e.respondWith(
        caches.open(CACHE_NAME).then(cache =>
          cache.match(req).then(hit =>
            hit || fetch(req).then(resp => { cache.put(req, resp.clone()); return resp; })
          )
        )
      );
    }else{
      // Network-first for OpenWeather; do not cache API responses (to avoid stale data)
      e.respondWith(fetch(req).catch(()=>caches.match(req)));
    }
  });
`;
const swBlob=new Blob([swCode],{type:'text/javascript'});
const swURL=URL.createObjectURL(swBlob);

if('serviceWorker' in navigator){
  navigator.serviceWorker.register(swURL).then(reg=>{
    // Show toast on first activation
    if(!navigator.serviceWorker.controller){
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{
        const t=document.getElementById('installToast');
        if(t){ t.style.display='block'; setTimeout(()=>t.style.display='none', 3500); }
      });
    }
  }).catch(err=>console.warn('SW registration failed:', err));
}

/* ==========================
   APP LOGIC (kept from your v5.5)
   ========================== */

window.addEventListener("DOMContentLoaded", ()=> {

  let OPENWEATHER_API_KEY = "Enter_key_here"; // placeholder replaced by your saved copy

  function ms_to_mph(ms){return ms*2.2369363;}
  function ms_to_knots(ms){return ms*1.9438445;}

  async function getWeather(){
    if(OPENWEATHER_API_KEY==="Enter_key_here"){
      alert("Please enter your OpenWeather API key first using the ReadMe button.");
      return;
    }
    const [lat,lon]=lake.value.split(',');
    const url=\`https://api.openweathermap.org/data/2.5/weather?lat=\${lat}&lon=\${lon}&units=metric&appid=\${OPENWEATHER_API_KEY}\`;
    weather.innerHTML="Loading...";
    try{
      const r=await fetch(url);
      if(!r.ok) throw new Error(await r.text());
      const d=await r.json();
      const w=d.wind||{};
      const ws=w.speed||0, wd=w.deg??"n/a", gust=w.gust??null;
      const t=d.main?.temp??"n/a", desc=d.weather?.[0]?.description??"n/a";
      const now=new Date().toLocaleString();
      weather.innerHTML=\`
        <h3>\${desc}, \${t}¬∞C</h3>
        <div class="wind-row">
          <div class="wind-item"><b>Wind:</b> \${ws.toFixed(1)} m/s (\${ms_to_mph(ws).toFixed(1)} mph, \${ms_to_knots(ws).toFixed(1)} kt)</div>
          \${gust? \`<div class="wind-item"><b>Gust:</b> \${gust.toFixed(1)} m/s (\${ms_to_mph(gust).toFixed(1)} mph)</div>\` : "<div class='wind-item'><i>No gust data</i></div>"}
          <div class="wind-item"><b>Dir:</b> \${wd}¬∞</div>
        </div>
        <p style='margin-top:8px;color:#555;font-size:0.9rem;'>Updated: \${now}</p>\`;
    }catch(e){
      weather.innerHTML=\`<p class="error">Error: \${e.message}</p>\`;
    }
  }

  // ----- Universal Save Helper -----
  async function saveHTMLWithPrompt(defaultName, htmlContent){
    try{
      if(window.showSaveFilePicker){
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: defaultName,
          types:[{description:"HTML Files", accept:{"text/html":[".html"]}}]
        });
        const writable = await fileHandle.createWritable();
        await writable.write(htmlContent); await writable.close();
        alert("‚úÖ File saved successfully!");
        return;
      }
    }catch(e){ /* fallback below */ }

    const filename = prompt("Enter filename for your saved copy:", defaultName) || defaultName;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    alert("‚úÖ File saved successfully!");
  }

  // ----- ReadMe / Key Entry -----
  async function readmeHandler(){
    const message = `
A free API key from OpenWeather is required for this program to function.

1Ô∏è‚É£ Visit: https://home.openweathermap.org/users/sign_up  
2Ô∏è‚É£ Sign up (free) and get your key under ‚ÄúMy API keys‚Äù.  
3Ô∏è‚É£ Paste your key below to permanently activate this app.

After you click OK, you will be prompted to save the updated file 
with your chosen name and location.
`;
    alert(message);

    const k = prompt("Enter your OpenWeather API key:");
    if(!k) return;

    let html = document.documentElement.outerHTML
      .replace('let OPENWEATHER_API_KEY = "Enter_key_here";', `let OPENWEATHER_API_KEY = "${k.trim()}";`)
      .replace(/<button[^>]*id=["']btnReadMe["'][^>]*>[\s\S]*?<\/button>/i,'<button id="btnReadMe" disabled>Key entered</button>');
    await saveHTMLWithPrompt("weather-mph-gust-v5-5-pwa-with-key.html", html);
  }

  // ----- New Location -----
  async function newLocation(){
    const name = prompt("Enter a name for the new location (e.g., 'Kingston Harbour'):");
    if(!name) return;

    const coords = prompt(
      "Enter GPS coordinates in decimal format (latitude,longitude)\n"+
      "Examples:\n  43.25,-79.87 ‚Üí valid (43.25¬∞N, 79.87¬∞W)\n"+
      "  -33.86,151.21 ‚Üí valid (Southern Hemisphere)\n\n"+
      "Latitude range: -90 to 90\nLongitude range: -180 to 180"
    );
    if(!coords) return;

    const [latStr, lonStr] = coords.split(',').map(s=>s.trim());
    const lat=parseFloat(latStr), lon=parseFloat(lonStr);
    if(isNaN(lat)||isNaN(lon)||lat<-90||lat>90||lon<-180||lon>180){
      alert("Invalid coordinates. Please enter decimal values like 43.25,-79.87");
      return;
    }

    const o=document.createElement('option');
    o.value=`${lat},${lon}`;
    o.textContent=`${name} (${lat.toFixed(2)}, ${lon.toFixed(2)})`;
    lake.insertBefore(o,lake.firstChild);
    lake.value=o.value;
    alert(`Added ${name} at [${lat.toFixed(4)}, ${lon.toFixed(4)}]`);

    if(confirm("Do you want to save this updated version (with the new location) as a new file?")){
      const html=document.documentElement.outerHTML;
      await saveHTMLWithPrompt("weather-mph-gust-v5-5-pwa-with-locations.html", html);
    }
  }

  // Event Listeners (same as v5.5 behavior)
  btnGet.addEventListener("click", getWeather);
  btnReadMe.addEventListener("click", readmeHandler);
  btnNewLoc.addEventListener("click", newLocation);
  aboutLink.addEventListener("click", e=>{e.preventDefault();aboutModal.style.display="block";});
  closeModal.addEventListener("click",()=>aboutModal.style.display="none");
  window.addEventListener("click", e=>{ if(e.target===aboutModal) aboutModal.style.display="none"; });

});
</script>
</body>
</html>
